name: Update Submodules and Rebuild Docker

on:
  schedule:
    # Run every 15 minutes
    - cron: '*/15 * * * *'
  workflow_dispatch:

jobs:
  update-submodules:
    runs-on: ubuntu-latest
    # Only run on main branch
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: write
      packages: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Update submodules to latest
        id: update
        run: |
          # Store current commit hashes
          OLD_POCX=$(git -C pocx rev-parse HEAD)
          OLD_BITCOIN=$(git -C bitcoin-pocx rev-parse HEAD)
          
          # Update submodules to latest from their tracked branches
          git submodule update --remote --merge
          
          # Get new commit hashes
          NEW_POCX=$(git -C pocx rev-parse HEAD)
          NEW_BITCOIN=$(git -C bitcoin-pocx rev-parse HEAD)
          
          # Check if there are changes
          if [ "$OLD_POCX" != "$NEW_POCX" ] || [ "$OLD_BITCOIN" != "$NEW_BITCOIN" ]; then
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "Submodules updated:"
            if [ "$OLD_POCX" != "$NEW_POCX" ]; then
              echo "  pocx: $OLD_POCX -> $NEW_POCX"
            fi
            if [ "$OLD_BITCOIN" != "$NEW_BITCOIN" ]; then
              echo "  bitcoin-pocx: $OLD_BITCOIN -> $NEW_BITCOIN"
            fi
          else
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "No submodule updates available"
          fi
      
      - name: Commit and push submodule updates
        if: steps.update.outputs.changes == 'true'
        run: |
          git add pocx bitcoin-pocx
          git commit -m "chore: update submodules to latest versions
          
          - pocx: $(git -C pocx rev-parse --short HEAD)
          - bitcoin-pocx: $(git -C bitcoin-pocx rev-parse --short HEAD)"
          git push
      
      - name: Trigger Docker build
        if: steps.update.outputs.changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'build-docker-images.yml',
              ref: 'main'
            });
